{% extends 'base.html' %}
{% load static %}
{% block title %}{{ story.title }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card mb-4">
            {% if story.illustration_url %}
            <img src="{{ story.illustration_url }}" class="card-img-top" alt="{{ story.title }}" style="max-height: 300px; object-fit: cover;">
            {% endif %}
            
            <div class="card-body">
                <h1>{{ story.title }}</h1>
                <p class="lead">{{ story.description }}</p>
                
                <div class="d-flex gap-3 mb-3">
                    <span class="badge bg-primary">{{ story.status }}</span>
                    <span>
                        {% for i in "12345" %}
                            {% if forloop.counter <= avg_rating %}
                            <i class="bi bi-star-fill text-warning"></i>
                            {% else %}
                            <i class="bi bi-star text-warning"></i>
                            {% endif %}
                        {% endfor %}
                        ({{ rating_count }} ratings)
                    </span>
                    <span><i class="bi bi-play-circle"></i> {{ stats.total_plays }} plays</span>
                </div>
                
                <a href="{% url 'gameplay:play' story.id %}" class="btn btn-success btn-lg">
                    <i class="bi bi-play-fill"></i> Play Story
                </a>
                
                {% if user.is_authenticated %}
                <a href="{% url 'community:report' story.id %}" class="btn btn-outline-danger">
                    <i class="bi bi-flag"></i> Report
                </a>
                {% endif %}
            </div>
        </div>
        
        {% if stats.endings %}
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="bi bi-bar-chart"></i> Ending Statistics</h5>
            </div>
            <div class="card-body">
                {% for ending in stats.endings %}
                <div class="mb-2">
                    <div class="d-flex justify-content-between">
                        <span>{{ ending.ending_label }}</span>
                        <span>{{ ending.percentage }}%</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar" style="width: {{ ending.percentage }}%"></div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-chat"></i> Comments</h5>
            </div>
            <div class="card-body">
                {% if user.is_authenticated %}
                <form method="post" action="{% url 'community:comment' story.id %}" class="mb-4">
                    {% csrf_token %}
                    <div class="mb-3">
                        <textarea name="text" class="form-control" rows="3" placeholder="Add a comment..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Post Comment</button>
                </form>
                {% endif %}
                
                {% for comment in comments %}
                <div class="border-bottom pb-3 mb-3">
                    <div class="d-flex justify-content-between">
                        <strong>{{ comment.user.username }}</strong>
                        <small class="text-muted">{{ comment.created_at|timesince }} ago</small>
                    </div>
                    <p class="mb-1">{{ comment.text }}</p>
                    {% if comment.user == user %}
                    <form method="post" action="{% url 'community:delete_comment' comment.id %}" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-link text-danger p-0">Delete</button>
                    </form>
                    {% endif %}
                </div>
                {% empty %}
                <p class="text-muted">No comments yet. Be the first!</p>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        {% if user.is_authenticated %}
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="bi bi-star"></i> Rate This Story</h5>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'community:rate' story.id %}">
                    {% csrf_token %}
                    <div class="rating-input mb-3">
                        {% for i in "54321" %}
                        <input type="radio" name="stars" value="{{ forloop.counter }}" id="star{{ forloop.counter }}" 
                               {% if user_rating and user_rating.stars == forloop.counter %}checked{% endif %}>
                        <label for="star{{ forloop.counter }}"><i class="bi bi-star-fill"></i></label>
                        {% endfor %}
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Submit Rating</button>
                </form>
            </div>
        </div>
        {% endif %}
        
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-diagram-3"></i> Story Map</h5>
            </div>
            <div class="card-body">
                <div id="story-tree" style="height: 300px;"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="{% static 'js/story_tree.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        renderStoryTree({{ story.id }});
    });
</script>
{% endblock %}
